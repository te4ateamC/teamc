<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>注文履歴</title>
    <link rel="stylesheet" href="\css\OrderHistory.css">
</head>

<body>
    <form action="/logout" method="post" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /><!--CSRF トークン-->
        <button type="submit">ログアウト</button>
    </form>
    <h2>注文履歴</h2>
    <div class="table-wrapper">
        <table border="1">
            <thead>
                <tr>
                    <th class="col-title">書籍名</th>
                    <th class="col-publisher">出版社</th>
                    <th class="col-count">冊数</th>
                    <th class="col-name">名前</th>
                    <th class="col-tel">電話番号</th>
                    <th class="col-address">email</th>
                    <th class="col-isbn">ISBNコード</th>
                    <th class="col-date">承認日</th>
                    <th class="col-amount">金額</th>
                    <th class="col-status">承認状況</th>
                    <th class="col-approve">承認ボタン</th>
                    <th class="col-complete">取引状況</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="reservation : ${reservationList}">
                    <td th:text="${reservation.title}"></td>
                    <td th:text="${reservation.publisher}"></td>
                    <td th:text="${reservation.count}"></td>
                    <td th:text="${reservation.name}"></td>
                    <td th:text="${reservation.tel}"></td>
                    <td th:text="${reservation.email}"></td>
                    <td th:text="${reservation.isbnCode} ?: ''"></td>
                    <td th:text="${reservation.approvalDate} ?: '未承認'"></td>
                    <td th:text="${reservation.amount} ?: '未入力'"></td>
                    <td id="approvalStatus" th:text="${reservation.approvalStatus} ?: '未承認'"></td>

                    <!-- 承認ボタン -->
                    <!--<td th:text="">取引未完了</td>-->
                    <td>
                        <form action="/reserveappro" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="title" th:value="${reservation.title}" />
                            <input type="hidden" name="publisher" th:value="${reservation.publisher}" />
                            <input type="hidden" name="count" th:value="${reservation.count}" />
                            <input type="hidden" name="name" th:value="${reservation.name}" />
                            <button type="submit">承認</button>
                        </form>

                    </td>

                    <!-- 取引完了ボタン -->
                    <td>
                        <form action="/complete" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="id" th:value="${reservation.id}" />
                            <button type="submit" class="complete-btn"
                                th:disabled="${reservation.completed}">取引完了</button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 共通ダイアログ -->
    <dialog id="trcom">
        <h5>取引を本当に確定してよろしいですか？</h5>
        <div style="margin-top:10px;">
            <button id="confirmComplete">完了</button>
            <button id="cancelComplete">キャンセル</button>
        </div>
    </dialog>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const dialog = document.getElementById("trcom");
            let targetRow = null;
            let targetForm = null;

            // 各行の「取引完了」ボタンにイベントを付与
            document.querySelectorAll(".complete-btn").forEach(btn => {
                btn.addEventListener("click", function (e) {
                    e.preventDefault(); // フォーム送信を止める
                    targetRow = btn.closest("tr");
                    targetForm = btn.closest("form");
                    dialog.showModal();
                });
            });

            // 「キャンセル」
            document.getElementById("cancelComplete").addEventListener("click", () => {
                dialog.close();
                targetRow = null;
                targetForm = null;
            });

            // 「完了」押下時
            document.getElementById("confirmComplete").addEventListener("click", () => {
                if (!targetForm || !targetRow) return;

                // フォーム内容をAjaxで送信
                const formData = new FormData(targetForm);
                fetch(targetForm.action, {
                    method: targetForm.method,
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) throw new Error("サーバーエラー");
                        return response.text(); // 必要ならJSONに変更
                    })
                    .then(() => {
                        // 成功したらグレーアウト
                        targetRow.classList.add("completed");
                        targetRow.querySelector(".complete-btn").disabled = true;

                        // 行を下に移動
                        const tbody = targetRow.parentNode;
                        tbody.appendChild(targetRow);

                        dialog.close();
                    })
                    .catch(err => {
                        console.error("通信エラー:", err);
                        dialog.close();
                    });
            });
        });
    </script>
</body>

</html>